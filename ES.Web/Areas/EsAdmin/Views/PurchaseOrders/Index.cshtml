@model IEnumerable<PurchaseOrderViewModel>

@using System.Globalization
@using ES.Web.Areas.EsAdmin.Models
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Purchase Orders"];
}

@section Styles {
    <link href="~/CMS/assets/plugins/datatable/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="~/CMS/css/translationindex.css" rel="stylesheet" />
}

<h6 class="mb-0 text-uppercase">@Localizer["Purchase Orders"]</h6>
<hr />

<div class="card">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-3">
                <input type="date" id="startDateFilter" class="form-control" placeholder="@Localizer["Start Date"]" />
            </div>
            <div class="col-3">
                <input type="date" id="endDateFilter" class="form-control" placeholder="@Localizer["End Date"]" />
            </div>
            <div class="col-3">
                <select id="archiveFilter" class="form-select">
                    <option value="">@Localizer["All"]</option>
                    <option value="true">@Localizer["Archived"]</option>
                    <option value="false">@Localizer["Not Archived"]</option>
                </select>
            </div>
            <div class="col-3">
                <a asp-controller="PurchaseOrders" asp-action="Create" class="btn btn-success w-100 d-flex align-items-center justify-content-center">
                    <ion-icon class="lni lni-plus me-2" style="font-size: 1.2rem;"></ion-icon>
                    @Localizer["Add new purchase order"]
                </a>
            </div>
        </div>

        <div class="table-responsive">
            <table id="table" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>@Localizer["Title"]</th>
                        <th>@Localizer["Start date"]</th>
                        <th>@Localizer["End date"]</th>
                        <th>@Localizer["Archived"]</th>
                        <th>@Localizer["Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr data-archive="@item.MoveToArchive.ToString().ToLower()"
                            data-start="@item.StartDate.ToString("yyyy-MM-dd")"
                            data-end="@item.EndDate.ToString("yyyy-MM-dd")">
                            <td>@item.Title</td>
                            <td>@item.StartDate.ToString("yyyy-MM-dd")</td>
                            <td>@item.EndDate.ToString("yyyy-MM-dd")</td>
                            <td>
                                @if (item.MoveToArchive)
                                {
                                    <span class="badge bg-danger">@Localizer["Yes"]</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">@Localizer["No"]</span>
                                }
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <a class="me-2"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       data-bs-original-title=@Localizer["Content management"]
                                       asp-controller="PurchaseOrdersTranslates" asp-action="Index" asp-route-purchaseOrderId="@item.Id">
                                        <ion-icon class="lni lni-pencil-alt md hover-scale text-warning" role="img"></ion-icon>
                                    </a>

                                    <a class="me-2"
                                       target="_blank"
                                       asp-controller="PurchaseOrders"
                                       asp-action="Index"
                                       asp-route-slug="@item.Slug"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       data-bs-original-title="@Localizer["Preview"]">
                                        <ion-icon class="lni lni-eye hover-scale md hover-scale text-info" role="img"></ion-icon>
                                    </a>

                                    <a class="me-2 toggle-archive"
                                       href="javascript:void(0);"
                                       data-purchaseOrder-id="@item.Id"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       data-bs-original-title="@(item.MoveToArchive? Localizer["Unarchive"] : Localizer["Move to Archive"])">
                                        @if (item.MoveToArchive)
                                        {
                                            <ion-icon class="lni lni-arrow-up-circle md hover-scale text-warning" role="img"></ion-icon>
                                        }
                                        else
                                        {
                                            <ion-icon class="lni lni-archive md hover-scale text-secondary" role="img"></ion-icon>
                                        }
                                    </a>

                                    <a class="me-2"
                                       onclick="deletePurchaseOrder('@item.Id', this)"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       data-bs-original-title=@Localizer["Delete purchase order"]>
                                        <i class="lni lni-trash md hover-scale text-danger"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Plugins {
    <script src="~/CMS/assets/plugins/datatable/js/jquery.dataTables.min.js"></script>
    <script src="~/CMS/assets/plugins/datatable/js/dataTables.bootstrap5.min.js"></script>
    <script src="~/CMS/assets/js/table-datatable.js"></script>
}

@section Scripts {
    <script>
        var currentLanguage = '@CultureInfo.CurrentCulture.Name';
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const archiveFilter = document.getElementById('archiveFilter');
            const startDateFilter = document.getElementById('startDateFilter');
            const endDateFilter = document.getElementById('endDateFilter');
            const tableRows = document.querySelectorAll('#table tbody tr');

            // Apply row filters
            function applyFilters() {
                const archiveValue = archiveFilter.value;
                const startValue = startDateFilter.value;
                const endValue = endDateFilter.value;

                tableRows.forEach(row => {
                    const isArchived = row.dataset.archive;
                    const rowStart = row.dataset.start;
                    const rowEnd = row.dataset.end;

                    let show = true;

                    if (archiveValue !== "" && archiveValue !== isArchived) show = false;
                    if (startValue && rowStart < startValue) show = false;
                    if (endValue && rowEnd > endValue) show = false;

                    row.style.display = show ? '' : 'none';
                });
            }

            archiveFilter.addEventListener('change', applyFilters);
            startDateFilter.addEventListener('change', applyFilters);
            endDateFilter.addEventListener('change', applyFilters);

            // Toggle archive
            document.querySelectorAll('.toggle-archive').forEach(button => {
                button.addEventListener('click', function () {
                    const purchaseOrderId = this.dataset.purchaseorderId; // fixed casing
                    const row = this.closest('tr');
                    const icon = this.querySelector('ion-icon');

                    if (!purchaseOrderId) return;

                    fetch(`/EsAdmin/PurchaseOrders/ToggleArchive/${purchaseOrderId}`, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed');

                        const archivedCell = row.querySelector('td:nth-child(4) span');
                        const isArchived = archivedCell.classList.contains('bg-danger');

                        if (isArchived) {
                            archivedCell.classList.replace('bg-danger', 'bg-success');
                            archivedCell.textContent = '@Localizer["No"]';
                            icon.className = 'lni lni-archive md hover-scale text-secondary';
                            this.setAttribute('data-bs-original-title', '@Localizer["Move to Archive"]');
                            row.dataset.archive = 'false';
                        } else {
                            archivedCell.classList.replace('bg-success', 'bg-danger');
                            archivedCell.textContent = '@Localizer["Yes"]';
                            icon.className = 'lni lni-arrow-up-circle md hover-scale text-warning';
                            this.setAttribute('data-bs-original-title', '@Localizer["Unarchive"]');
                            row.dataset.archive = 'true';
                        }

                        applyFilters();

                        // Reinitialize tooltip
                        new bootstrap.Tooltip(this);

                    })
                    .catch(() => {
                        alert('@Localizer["Failed to update archive status."]');
                    });
                });
            });

            // Initialize all tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

        });
    </script>

    <script src="~/CMS/js/purchaseOrderIndex.js"></script>
}
