@model BranchFormViewModel

@using System.Globalization
@using ES.Web.Areas.EsAdmin.Models
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Branch"];
}

@section Styles {
    <link href="~/CMS/lib/dropzone/dropzone.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.1.1/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
}
@{
    var defaultLangValue = "1"; // 1 = English by default, change dynamically if needed
}

@{
    var nonDefaultLanguages = Model.Languages
    .Where(l => l.Value != defaultLangValue)
    .Select((l, i) => new { Index = i, l.Value, l.Text })
    .ToList();
}

<div class="row">
    <div class="col-xl-12 mx-auto">
        <div class="card">
            <div class="card-body">
                <div class="border p-3 rounded">
                    <h6 class="mb-0 text-uppercase">
                        @((Model.Id > 0)
                                                ? Localizer["Edit Branch"]
                                                : Localizer["Add Branch"])
                    </h6>
                    <hr>
                    <form id="my-Form" method="post" enctype="multipart/form-data" asp-controller="Branches">
                        @Html.AntiForgeryToken()
                        @if (Model?.Id is not null)
                        {
                            <input type="hidden" asp-for="Id" />
                        }
                        <div class="row g-3">

                            <!-- Branch Name -->
                            <div class="col-md-12">
                                <label class="form-label">@Localizer["Branch name"]</label>
                                <input asp-for="Name" class="form-control"
                                       disabled="@(Model.Name == "Home Slider" ? "disabled" : null)" />

                                @if (Model.Name == "Home Slider")
                                {
                                    <input type="hidden" asp-for="Name" />
                                }

                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>



                           
                            <h5 class="mt-4">Hangars</h5>
                            <div id="hangars-container">
                                @for (int i = 0; i < Model.Hangars.Count; i++)
                                {
                                    <div class="hangar-row mb-3" data-index="@i">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <input class="form-control" name="Hangars[@i].Name" value="@Model.Hangars[i].Name" placeholder="Name" />
                                            </div>
                                            <div class="col-md-3">
                                                <input class="form-control" name="Hangars[@i].Size" value="@Model.Hangars[i].Size" placeholder="Size" />
                                            </div>
                                            <div class="col-md-3">
                                                <input class="form-control" name="Hangars[@i].Type" value="@Model.Hangars[i].Type" placeholder="Type" />
                                            </div>
                                            <div class="col-md-3">
                                                <button type="button" class="btn btn-danger remove-item">X</button>
                                            </div>
                                        </div>

                                        <!-- Translations -->
                                        @foreach (var lang in nonDefaultLanguages)
                                        {
                                            var tr = Model.Hangars[i].Translates
                                            .FirstOrDefault(x => x.LanguageId?.ToString() == lang.Value);

                                            <div class="row mt-1">
                                                <div class="col-md-3">
                                                    <input class="form-control" name="Hangars[@i].Translates[@lang.Index].Name"
                                                           placeholder="Name (@lang.Text)" value="@tr?.Name" />
                                                </div>
                                                <div class="col-md-3">
                                                    <input class="form-control" name="Hangars[@i].Translates[@lang.Index].Size"
                                                           placeholder="Size (@lang.Text)" value="@tr?.Size" />
                                                </div>
                                                <div class="col-md-3">
                                                    <input class="form-control" name="Hangars[@i].Translates[@lang.Index].Type"
                                                           placeholder="Type (@lang.Text)" value="@tr?.Type" />
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="hidden" name="Hangars[@i].Translates[@lang.Index].LanguageId" value="@lang.Value" />
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>

                            <button type="button" class="btn btn-success mt-2" id="add-hangar">+ Add Hangar</button>


                            <h5 class="mt-4">Refrigators</h5>
                            <div id="refrigator-container">
                                @for (int i = 0; i < Model.Refrigators.Count; i++)
                                {
                                    <div class="refrigator-row mb-3" data-index="@i">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <input class="form-control" name="Refrigators[@i].Name" value="@Model.Refrigators[i].Name" placeholder="Name" />
                                            </div>
                                            <div class="col-md-3">
                                                <input class="form-control" name="Refrigators[@i].Size" value="@Model.Refrigators[i].Size" placeholder="Size" />
                                            </div>
                                            <div class="col-md-3">
                                                <input class="form-control" name="Refrigators[@i].Type" value="@Model.Refrigators[i].Type" placeholder="Type" />
                                            </div>
                                            <div class="col-md-3">
                                                <button type="button" class="btn btn-danger remove-item">X</button>
                                            </div>
                                        </div>

                                        <!-- Translations -->
                                        @foreach (var lang in nonDefaultLanguages)
                                        {
                                            var tr = Model.Refrigators[i].Translates
                                            .FirstOrDefault(x => x.LanguageId?.ToString() == lang.Value);

                                            <div class="row mt-1">
                                                <div class="col-md-3">
                                                    <input class="form-control" name="Refrigators[@i].Translates[@lang.Index].Name"
                                                           placeholder="Name (@lang.Text)" value="@tr?.Name" />
                                                </div>
                                                <div class="col-md-3">
                                                    <input class="form-control" name="Refrigators[@i].Translates[@lang.Index].Size"
                                                           placeholder="Size (@lang.Text)" value="@tr?.Size" />
                                                </div>
                                                <div class="col-md-3">
                                                    <input class="form-control" name="Refrigators[@i].Translates[@lang.Index].Type"
                                                           placeholder="Type (@lang.Text)" value="@tr?.Type" />
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="hidden" name="Refrigators[@i].Translates[@lang.Index].LanguageId" value="@lang.Value" />
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>

                            <button type="button" class="btn btn-success mt-2" id="add-refrigator">+ Add Refrigator</button>


                           

                         

                         



                          
                        </div>
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">@Localizer["Submit"]</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script src="~/CMS/lib/dropzone/dropzone.min.js"></script>
    <script src="~/CMS/lib/sortable/sortable.min.js"></script>

    <partial name="_ValidationScriptsPartial" />
    <script src="~/CMS/js/tinyMce.js"></script>
    <script>
       
         var currentLanguage = '@CultureInfo.CurrentCulture.Name';
    </script>

    <script src="~/CMS/js/branchForm.js"></script>

    <script>
        let hangarIndex = @Model.Hangars.Count;
        let refrigatorIndex = @Model.Refrigators.Count;

        const languages = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(nonDefaultLanguages));

        function generateRow(type, index) {
            let html = `
                <div class="${type}-row mb-3" data-index="${index}">
                    <div class="row">
                        <div class="col-md-3"><input class="form-control" name="${type}[${index}].Name" placeholder="Name" /></div>
                        <div class="col-md-3"><input class="form-control" name="${type}[${index}].Size" placeholder="Size" /></div>
                        <div class="col-md-3"><input class="form-control" name="${type}[${index}].Type" placeholder="Type" /></div>
                        <div class="col-md-3"><button type="button" class="btn btn-danger remove-item">X</button></div>
                    </div>
            `;

            languages.forEach(l => {
                html += `
                    <div class="row mt-1">
                        <div class="col-md-3"><input class="form-control" name="${type}[${index}].Translates[${l.Index}].Name" placeholder="Name (${l.Text})" /></div>
                        <div class="col-md-3"><input class="form-control" name="${type}[${index}].Translates[${l.Index}].Size" placeholder="Size (${l.Text})" /></div>
                        <div class="col-md-3"><input class="form-control" name="${type}[${index}].Translates[${l.Index}].Type" placeholder="Type (${l.Text})" /></div>
                        <div class="col-md-3"><input type="hidden" name="${type}[${index}].Translates[${l.Index}].LanguageId" value="${l.Value}" /></div>
                    </div>`;
            });

            html += `</div>`;
            return html;
        }

        document.getElementById("add-hangar").onclick = () => {
            document.getElementById("hangars-container").insertAdjacentHTML(
                'beforeend',
                generateRow("Hangars", hangarIndex++)
            );
        };

        document.getElementById("add-refrigator").onclick = () => {
            document.getElementById("refrigator-container").insertAdjacentHTML(
                'beforeend',
                generateRow("Refrigators", refrigatorIndex++)
            );
        };

        document.addEventListener("click", e => {
            if (e.target.classList.contains("remove-item")) {
                e.target.closest(".hangar-row, .refrigator-row").remove();
            }
        });
    </script>



}